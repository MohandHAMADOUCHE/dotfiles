#!/usr/bin/env bash
set -euo pipefail

# Remote environment detection (no templating dependency)
if [[ -n "${SSH_CONNECTION:-}" \
   || -f "/.dockerenv" \
   || -n "${CODESPACES:-}" \
   || -n "${KUBERNETES_SERVICE_HOST:-}" \
   || -n "${REMOTE_CONTAINERS:-}" \
   || -n "${container:-}" ]]; then
  exit 0
fi

# Install eza if missing. Runs once via chezmoi.
if command -v eza >/dev/null 2>&1; then
  exit 0
fi

has() { command -v "$1" >/dev/null 2>&1; }

# Use sudo when available and not root
SUDO=""
if [ "${EUID:-$(id -u)}" -ne 0 ]; then
  if has sudo; then
    SUDO="sudo"
  fi
fi

if has apt-get; then
  ${SUDO} apt-get update -y || true
  ${SUDO} apt-get install -y eza || echo "Could not install eza via apt-get. Install manually."
elif has dnf; then
  ${SUDO} dnf install -y eza || echo "Could not install eza via dnf. Install manually."
elif has pacman; then
  ${SUDO} pacman -Sy --noconfirm eza || echo "Could not install eza via pacman. Install manually."
elif has brew; then
  brew install eza || echo "Could not install eza via brew. Install manually."
else
  echo "No supported package manager found. Please install eza manually."
fi
